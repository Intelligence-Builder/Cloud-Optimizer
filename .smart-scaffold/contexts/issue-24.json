{
  "issue_number": 24,
  "title": "6.2 AWS Marketplace Integration",
  "body": "# 6.2 AWS Marketplace Integration\n\n## Parent Epic\nEpic 6: MVP Phase 1 - Container Product Foundation\n\n## Overview\n\nIntegrate Cloud Optimizer with AWS Marketplace for container product distribution. This enables license validation, usage metering, and trial management through AWS Marketplace APIs.\n\n## Background\n\nCloud Optimizer is distributed as an **AWS Marketplace Container Product** with:\n- 14-day free trial period\n- Usage-based pricing (scans, chat questions, document analysis)\n- Automatic license validation on container startup\n- Usage metering for billing\n\n## Requirements\n\n| ID | Requirement | Acceptance Criteria |\n|----|-------------|---------------------|\n| MKT-001 | License validation | `RegisterUsage` API call on startup, handles VALID/TRIAL/EXPIRED states |\n| MKT-002 | Usage metering | `MeterUsage` API reports dimensions: SecurityScans, ChatQuestions, DocumentAnalysis |\n| MKT-003 | Trial enforcement | 14-day trial with limits, graceful expiration handling |\n| MKT-004 | Entitlement check | Hourly entitlement validation, handles subscription changes |\n| MKT-005 | Subscription handling | Graceful degradation on subscription issues, clear error messages |\n\n## Technical Specification\n\n### Marketplace Product Configuration\n\n```yaml\nProduct:\n  Type: Container\n  DeliveryMethod: AWS Marketplace Container\n  PricingModel: Usage-Based\n\n  Dimensions:\n    - Name: SecurityScans\n      Description: Number of AWS account scans performed\n      Unit: Scans\n      PricePerUnit: $0.50\n\n    - Name: ChatQuestions\n      Description: Security Q&A questions asked\n      Unit: Questions\n      PricePerUnit: $0.02\n\n    - Name: DocumentAnalysis\n      Description: Architecture documents analyzed\n      Unit: Documents\n      PricePerUnit: $0.25\n\n  Trial:\n    Duration: 14 days\n    Limits:\n      SecurityScans: 50\n      ChatQuestions: 500\n      DocumentAnalysis: 20\n```\n\n### License Validation Service\n\n```python\n# src/cloud_optimizer/marketplace/license.py\nfrom enum import Enum\nimport boto3\n\nclass LicenseStatus(Enum):\n    VALID = \"valid\"           # Paid subscription active\n    TRIAL = \"trial\"           # In trial period\n    TRIAL_EXPIRED = \"trial_expired\"\n    SUBSCRIPTION_EXPIRED = \"subscription_expired\"\n    INVALID = \"invalid\"\n\nclass MarketplaceLicenseValidator:\n    def __init__(self, product_code: str):\n        self.product_code = product_code\n        self.client = boto3.client('meteringmarketplace')\n\n    async def validate_on_startup(self) -> LicenseStatus:\n        \"\"\"Called when container starts.\"\"\"\n        try:\n            response = self.client.register_usage(\n                ProductCode=self.product_code,\n                PublicKeyVersion=1,\n            )\n            logger.info(\n                \"License validated\",\n                customer_id=response.get(\"CustomerIdentifier\"),\n                product_code=self.product_code,\n            )\n            return LicenseStatus.VALID\n\n        except self.client.exceptions.CustomerNotEntitledException:\n            # No paid subscription - check for trial\n            return await self._check_trial_status()\n\n        except self.client.exceptions.CustomerNotSubscribedException:\n            logger.warning(\"Subscription expired or cancelled\")\n            return LicenseStatus.SUBSCRIPTION_EXPIRED\n\n        except Exception as e:\n            logger.error(\"License validation failed\", error=str(e))\n            return LicenseStatus.INVALID\n\n    async def _check_trial_status(self) -> LicenseStatus:\n        \"\"\"Check if trial is active or expired.\"\"\"\n        trial_start = await self._get_trial_start_date()\n        if trial_start is None:\n            # First run - start trial\n            await self._start_trial()\n            return LicenseStatus.TRIAL\n\n        days_elapsed = (datetime.utcnow() - trial_start).days\n        if days_elapsed > 14:\n            return LicenseStatus.TRIAL_EXPIRED\n\n        return LicenseStatus.TRIAL\n```\n\n### Usage Metering Service\n\n```python\n# src/cloud_optimizer/marketplace/metering.py\nclass UsageMeteringService:\n    DIMENSIONS = {\n        \"scan\": \"SecurityScans\",\n        \"chat\": \"ChatQuestions\",\n        \"document\": \"DocumentAnalysis\",\n    }\n\n    def __init__(self, product_code: str, enabled: bool = True):\n        self.product_code = product_code\n        self.enabled = enabled\n        self.client = boto3.client('meteringmarketplace')\n        self._buffer: List[UsageRecord] = []\n        self._buffer_lock = asyncio.Lock()\n\n    async def record_usage(self, dimension: str, quantity: int = 1):\n        \"\"\"Record usage for billing.\"\"\"\n        if not self.enabled:\n            return\n\n        if dimension not in self.DIMENSIONS:\n            raise ValueError(f\"Invalid dimension: {dimension}\")\n\n        async with self._buffer_lock:\n            self._buffer.append(UsageRecord(\n                dimension=self.DIMENSIONS[dimension],\n                quantity=quantity,\n                timestamp=datetime.utcnow(),\n            ))\n\n        # Flush if buffer exceeds threshold\n        if len(self._buffer) >= 10:\n            await self._flush_buffer()\n\n    async def _flush_buffer(self):\n        \"\"\"Send buffered usage to Marketplace.\"\"\"\n        async with self._buffer_lock:\n            if not self._buffer:\n                return\n\n            records = self._buffer.copy()\n            self._buffer.clear()\n\n        # Aggregate by dimension\n        aggregated = self._aggregate_records(records)\n\n        for dimension, quantity in aggregated.items():\n            try:\n                self.client.meter_usage(\n                    ProductCode=self.product_code,\n                    Timestamp=datetime.utcnow(),\n                    UsageDimension=dimension,\n                    UsageQuantity=quantity,\n                )\n                logger.info(\"Usage metered\", dimension=dimension, quantity=quantity)\n            except Exception as e:\n                logger.error(\"Metering failed\", dimension=dimension, error=str(e))\n                # Re-add to buffer for retry\n                self._buffer.extend([\n                    UsageRecord(dimension=dimension, quantity=quantity, timestamp=datetime.utcnow())\n                ])\n```\n\n### License Middleware\n\n```python\n# src/cloud_optimizer/middleware/license.py\nclass LicenseMiddleware:\n    \"\"\"Enforce license status on API requests.\"\"\"\n\n    ALWAYS_ALLOWED = [\"/health\", \"/docs\", \"/openapi.json\"]\n\n    def __init__(self, app: ASGIApp, license_service: MarketplaceLicenseValidator):\n        self.app = app\n        self.license_service = license_service\n\n    async def __call__(self, scope: Scope, receive: Receive, send: Send):\n        if scope[\"type\"] != \"http\":\n            await self.app(scope, receive, send)\n            return\n\n        path = scope[\"path\"]\n\n        # Always allow health checks\n        if any(path.startswith(p) for p in self.ALWAYS_ALLOWED):\n            await self.app(scope, receive, send)\n            return\n\n        # Check license status\n        status = await self.license_service.get_cached_status()\n\n        if status in [LicenseStatus.TRIAL_EXPIRED, LicenseStatus.SUBSCRIPTION_EXPIRED]:\n            response = JSONResponse(\n                status_code=402,\n                content={\n                    \"error\": \"subscription_required\",\n                    \"message\": \"Your trial has expired. Please subscribe via AWS Marketplace.\",\n                    \"marketplace_url\": \"https://aws.amazon.com/marketplace/pp/xxx\",\n                },\n            )\n            await response(scope, receive, send)\n            return\n\n        await self.app(scope, receive, send)\n```\n\n## Files to Create\n\n```\nsrc/cloud_optimizer/marketplace/\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 license.py              # License validation\n\u251c\u2500\u2500 metering.py             # Usage metering\n\u251c\u2500\u2500 models.py               # Pydantic models\n\u2514\u2500\u2500 exceptions.py           # Custom exceptions\n\nsrc/cloud_optimizer/middleware/\n\u251c\u2500\u2500 __init__.py\n\u2514\u2500\u2500 license.py              # License enforcement middleware\n\ntests/marketplace/\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 test_license.py\n\u251c\u2500\u2500 test_metering.py\n\u2514\u2500\u2500 conftest.py             # Mocked AWS clients\n```\n\n## Files to Modify\n\n```\nsrc/cloud_optimizer/main.py          # Add license middleware\nsrc/cloud_optimizer/config.py        # Add MARKETPLACE_* settings\nsrc/cloud_optimizer/entrypoint.py    # License validation on startup\n```\n\n## Environment Variables\n\n```bash\n# Required for Marketplace integration\nMARKETPLACE_ENABLED=true\nMARKETPLACE_PRODUCT_CODE=abc123xyz\nAWS_REGION=us-east-1\n\n# Trial mode (when no Marketplace)\nTRIAL_MODE=false\n```\n\n## Testing Requirements\n\n### Unit Tests\n- [ ] `test_license_valid.py` - Valid subscription returns VALID\n- [ ] `test_license_trial.py` - No subscription starts trial\n- [ ] `test_license_expired.py` - Expired trial returns TRIAL_EXPIRED\n- [ ] `test_metering_record.py` - Usage records buffered correctly\n- [ ] `test_metering_flush.py` - Buffer flushed to Marketplace API\n- [ ] `test_middleware_expired.py` - 402 returned when expired\n\n### Integration Tests\n- [ ] `test_marketplace_integration.py` - Full flow with mocked AWS\n- [ ] `test_trial_enforcement.py` - Trial limits enforced\n\n### Mocking Strategy\n\n```python\n# tests/marketplace/conftest.py\n@pytest.fixture\ndef mock_marketplace_client():\n    with patch('boto3.client') as mock:\n        client = MagicMock()\n        mock.return_value = client\n        yield client\n\n@pytest.fixture\ndef valid_subscription(mock_marketplace_client):\n    mock_marketplace_client.register_usage.return_value = {\n        \"CustomerIdentifier\": \"customer-123\",\n    }\n    return mock_marketplace_client\n```\n\n## Acceptance Criteria Checklist\n\n- [ ] License validation runs on container startup\n- [ ] Valid subscription allows full access\n- [ ] Trial mode starts when no subscription exists\n- [ ] Trial expires after 14 days\n- [ ] API returns 402 when trial/subscription expired\n- [ ] Usage metering records all billable actions\n- [ ] Metering buffer flushes every 10 records or 60 seconds\n- [ ] Metering failures are logged and retried\n- [ ] All tests pass with mocked AWS clients\n- [ ] Works with LocalStack for local development\n- [ ] 80%+ test coverage\n\n## Dependencies\n\n- 6.1 Container Packaging (needs Docker image)\n\n## Blocked By\n\n- 6.1 Container Packaging\n\n## Blocks\n\n- 6.3 Trial Management (uses license status)\n\n## Estimated Effort\n\n1 week\n\n## Labels\n\n`marketplace`, `aws`, `billing`, `mvp`, `phase-1`, `P0`\n\n## Reference Documents\n\n- [DEPLOYMENT.md](../04-operations/DEPLOYMENT.md) - Section 8: AWS Marketplace\n- [AWS Marketplace Metering API](https://docs.aws.amazon.com/marketplace/latest/userguide/metering-service.html)\n",
  "labels": [
    "mvp",
    "phase-1",
    "P0",
    "marketplace",
    "aws",
    "billing"
  ],
  "assignees": [],
  "milestone": null,
  "created_at": null,
  "updated_at": null,
  "state": "OPEN",
  "context": {
    "complexity": "medium",
    "effort": "medium",
    "confidence": 0.8,
    "required_expertise": [
      "backend"
    ],
    "dependencies": [],
    "related_files": []
  },
  "generated_at": "2025-12-04T10:21:23.887235Z",
  "generated_by": "smart-scaffold-cli",
  "branch_name": "feature/issue-24-62awsmarketplaceintegration"
}