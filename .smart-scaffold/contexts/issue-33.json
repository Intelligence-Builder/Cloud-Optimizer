{
  "issue_number": 33,
  "title": "7.5 Compliance Framework Mapping",
  "body": "# 7.5 Compliance Framework Mapping\n\n## Parent Epic\nEpic 7: MVP Phase 2 - Security & Cost Scanning\n\n## Overview\n\nImplement compliance framework mapping that associates security findings with relevant compliance requirements (HIPAA, SOC2, PCI-DSS, GDPR, CIS Benchmarks, NIST). Enables compliance-focused reporting and chat queries.\n\n## Background\n\nTrial customers often have compliance requirements driving their security initiatives. Mapping findings to compliance frameworks:\n- Provides business context for findings\n- Enables compliance-focused filtering\n- Supports audit preparation\n- Differentiates from basic scanning tools\n\n## Requirements\n\n| ID | Requirement | Acceptance Criteria |\n|----|-------------|---------------------|\n| CMP-001 | Framework data model | Store frameworks, controls, requirements with hierarchy |\n| CMP-002 | Finding mapping | Map security rules to compliance controls |\n| CMP-003 | Coverage reporting | Show % of framework controls covered by scans |\n| CMP-004 | Compliance queries | Filter findings by framework, get compliance summary |\n\n## Technical Specification\n\n### Compliance Data Model\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Compliance Framework                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502  \u2502  Framework (e.g., HIPAA)                                        \u2502\u2502\n\u2502  \u2502    \u2514\u2500\u2500 Domain (e.g., Technical Safeguards)                      \u2502\u2502\n\u2502  \u2502         \u2514\u2500\u2500 Control (e.g., Access Control)                      \u2502\u2502\n\u2502  \u2502              \u2514\u2500\u2500 Requirement (e.g., Unique User ID)             \u2502\u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2502                              \u2502                                       \u2502\n\u2502                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                            \u2502\n\u2502                    \u2502 Rule Mappings     \u2502                            \u2502\n\u2502                    \u2502 SEC_001 \u2192 HIPAA   \u2502                            \u2502\n\u2502                    \u2502          SOC2     \u2502                            \u2502\n\u2502                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n### Database Schema\n\n```sql\n-- Compliance frameworks\nCREATE TABLE compliance_frameworks (\n    framework_id VARCHAR(20) PRIMARY KEY,  -- 'HIPAA', 'SOC2', etc.\n    name VARCHAR(100) NOT NULL,\n    description TEXT,\n    version VARCHAR(20),\n    effective_date DATE,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\n-- Compliance domains (top-level grouping)\nCREATE TABLE compliance_domains (\n    domain_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    framework_id VARCHAR(20) NOT NULL REFERENCES compliance_frameworks(framework_id),\n    domain_code VARCHAR(50) NOT NULL,\n    name VARCHAR(255) NOT NULL,\n    description TEXT,\n    sort_order INTEGER,\n    UNIQUE(framework_id, domain_code)\n);\n\n-- Compliance controls\nCREATE TABLE compliance_controls (\n    control_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    domain_id UUID NOT NULL REFERENCES compliance_domains(domain_id),\n    control_code VARCHAR(50) NOT NULL,\n    name VARCHAR(255) NOT NULL,\n    description TEXT,\n    sort_order INTEGER\n);\n\n-- Security rule to compliance mappings\nCREATE TABLE rule_compliance_mappings (\n    mapping_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    rule_id VARCHAR(50) NOT NULL,        -- 'S3_001', 'EC2_001', etc.\n    control_id UUID NOT NULL REFERENCES compliance_controls(control_id),\n    relevance VARCHAR(20) NOT NULL,      -- 'direct', 'supporting'\n    notes TEXT,\n    UNIQUE(rule_id, control_id)\n);\n\nCREATE INDEX idx_mappings_rule ON rule_compliance_mappings(rule_id);\nCREATE INDEX idx_mappings_control ON rule_compliance_mappings(control_id);\n```\n\n### Compliance Data (Seeded)\n\n```yaml\n# data/compliance/hipaa.yaml\nframework:\n  id: HIPAA\n  name: Health Insurance Portability and Accountability Act\n  version: \"2013\"\n  description: US healthcare data privacy regulation\n\ndomains:\n  - code: \"164.312\"\n    name: Technical Safeguards\n    controls:\n      - code: \"164.312(a)(1)\"\n        name: Access Control\n        description: Implement technical policies to allow access only to authorized persons\n        requirements:\n          - \"Unique User Identification\"\n          - \"Emergency Access Procedure\"\n          - \"Automatic Logoff\"\n          - \"Encryption and Decryption\"\n\n      - code: \"164.312(a)(2)(iv)\"\n        name: Encryption and Decryption\n        description: Implement mechanism to encrypt/decrypt ePHI\n\n      - code: \"164.312(b)\"\n        name: Audit Controls\n        description: Implement mechanisms to record and examine access\n\n      - code: \"164.312(c)(1)\"\n        name: Integrity\n        description: Implement policies to protect ePHI from improper alteration\n\n      - code: \"164.312(d)\"\n        name: Person or Entity Authentication\n        description: Implement procedures to verify identity\n\n      - code: \"164.312(e)(1)\"\n        name: Transmission Security\n        description: Implement security measures for electronic transmission\n\n# Rule mappings\nmappings:\n  - rule_id: S3_001  # Public Access\n    control: \"164.312(a)(1)\"\n    relevance: direct\n\n  - rule_id: S3_002  # Encryption\n    control: \"164.312(a)(2)(iv)\"\n    relevance: direct\n\n  - rule_id: S3_004  # Logging\n    control: \"164.312(b)\"\n    relevance: direct\n\n  - rule_id: IAM_002  # MFA\n    control: \"164.312(d)\"\n    relevance: direct\n```\n\n### Compliance Service\n\n```python\n# src/cloud_optimizer/services/compliance.py\nclass ComplianceService:\n    def __init__(self, db: AsyncSession):\n        self.db = db\n\n    async def get_frameworks(self) -> list[ComplianceFramework]:\n        \"\"\"Get all compliance frameworks.\"\"\"\n        result = await self.db.execute(select(ComplianceFramework))\n        return result.scalars().all()\n\n    async def get_framework_details(\n        self, framework_id: str\n    ) -> ComplianceFrameworkDetails:\n        \"\"\"Get framework with domains and controls.\"\"\"\n        framework = await self.db.execute(\n            select(ComplianceFramework)\n            .where(ComplianceFramework.framework_id == framework_id)\n        )\n        framework = framework.scalar_one_or_none()\n        if not framework:\n            raise FrameworkNotFoundException()\n\n        domains = await self.db.execute(\n            select(ComplianceDomain)\n            .where(ComplianceDomain.framework_id == framework_id)\n            .order_by(ComplianceDomain.sort_order)\n        )\n\n        return ComplianceFrameworkDetails(\n            framework=framework,\n            domains=domains.scalars().all(),\n        )\n\n    async def get_compliance_status(\n        self,\n        tenant_id: UUID,\n        framework_id: str,\n    ) -> ComplianceStatus:\n        \"\"\"Get compliance status for a framework based on findings.\"\"\"\n        # Get all controls for framework\n        controls_query = select(ComplianceControl).join(\n            ComplianceDomain\n        ).where(ComplianceDomain.framework_id == framework_id)\n\n        controls = (await self.db.execute(controls_query)).scalars().all()\n\n        # Get findings mapped to this framework\n        findings_query = select(SecurityFinding).where(\n            SecurityFinding.tenant_id == tenant_id,\n            SecurityFinding.compliance_frameworks.contains([framework_id]),\n            SecurityFinding.status == \"open\",\n        )\n\n        findings = (await self.db.execute(findings_query)).scalars().all()\n\n        # Calculate status per control\n        control_status = []\n        for control in controls:\n            # Get rules mapped to this control\n            mappings = await self._get_control_mappings(control.control_id)\n            rule_ids = [m.rule_id for m in mappings]\n\n            # Find violations for these rules\n            violations = [f for f in findings if f.rule_id in rule_ids]\n\n            status = \"compliant\" if not violations else \"non_compliant\"\n            if not rule_ids:\n                status = \"not_assessed\"\n\n            control_status.append(\n                ControlStatus(\n                    control=control,\n                    status=status,\n                    violation_count=len(violations),\n                    findings=violations[:3],  # Top 3 for preview\n                )\n            )\n\n        # Calculate overall compliance percentage\n        assessed = [c for c in control_status if c.status != \"not_assessed\"]\n        compliant = [c for c in assessed if c.status == \"compliant\"]\n\n        compliance_pct = (\n            len(compliant) / len(assessed) * 100 if assessed else 0\n        )\n\n        return ComplianceStatus(\n            framework_id=framework_id,\n            compliance_percentage=compliance_pct,\n            total_controls=len(controls),\n            compliant_controls=len(compliant),\n            non_compliant_controls=len(assessed) - len(compliant),\n            not_assessed_controls=len(controls) - len(assessed),\n            controls=control_status,\n        )\n\n    async def get_findings_by_framework(\n        self,\n        tenant_id: UUID,\n        framework_id: str,\n    ) -> list[SecurityFinding]:\n        \"\"\"Get all findings for a compliance framework.\"\"\"\n        result = await self.db.execute(\n            select(SecurityFinding)\n            .where(\n                SecurityFinding.tenant_id == tenant_id,\n                SecurityFinding.compliance_frameworks.contains([framework_id]),\n            )\n            .order_by(\n                case(\n                    (SecurityFinding.severity == \"critical\", 1),\n                    (SecurityFinding.severity == \"high\", 2),\n                    (SecurityFinding.severity == \"medium\", 3),\n                    (SecurityFinding.severity == \"low\", 4),\n                )\n            )\n        )\n        return result.scalars().all()\n\n    async def map_finding_to_frameworks(\n        self, rule_id: str\n    ) -> list[str]:\n        \"\"\"Get frameworks a rule maps to.\"\"\"\n        result = await self.db.execute(\n            select(ComplianceFramework.framework_id)\n            .join(ComplianceDomain)\n            .join(ComplianceControl)\n            .join(RuleComplianceMapping)\n            .where(RuleComplianceMapping.rule_id == rule_id)\n            .distinct()\n        )\n        return result.scalars().all()\n```\n\n### Data Loader\n\n```python\n# src/cloud_optimizer/compliance/loader.py\nimport yaml\nfrom pathlib import Path\n\nclass ComplianceDataLoader:\n    DATA_DIR = Path(\"data/compliance\")\n\n    FRAMEWORKS = [\"hipaa\", \"soc2\", \"pci-dss\", \"gdpr\", \"cis\", \"nist\"]\n\n    async def load_all(self, db: AsyncSession):\n        \"\"\"Load all compliance data from YAML files.\"\"\"\n        for framework in self.FRAMEWORKS:\n            await self._load_framework(db, framework)\n        await db.commit()\n\n    async def _load_framework(self, db: AsyncSession, name: str):\n        \"\"\"Load single framework from YAML.\"\"\"\n        path = self.DATA_DIR / f\"{name}.yaml\"\n        if not path.exists():\n            logger.warning(f\"Compliance data not found: {path}\")\n            return\n\n        with open(path) as f:\n            data = yaml.safe_load(f)\n\n        # Create framework\n        framework = ComplianceFramework(\n            framework_id=data[\"framework\"][\"id\"],\n            name=data[\"framework\"][\"name\"],\n            description=data[\"framework\"].get(\"description\"),\n            version=data[\"framework\"].get(\"version\"),\n        )\n        db.add(framework)\n\n        # Create domains and controls\n        for domain_data in data.get(\"domains\", []):\n            domain = ComplianceDomain(\n                framework_id=framework.framework_id,\n                domain_code=domain_data[\"code\"],\n                name=domain_data[\"name\"],\n                description=domain_data.get(\"description\"),\n            )\n            db.add(domain)\n            await db.flush()  # Get domain_id\n\n            for control_data in domain_data.get(\"controls\", []):\n                control = ComplianceControl(\n                    domain_id=domain.domain_id,\n                    control_code=control_data[\"code\"],\n                    name=control_data[\"name\"],\n                    description=control_data.get(\"description\"),\n                )\n                db.add(control)\n                await db.flush()\n\n        # Create mappings\n        for mapping_data in data.get(\"mappings\", []):\n            # Find control by code\n            control = await db.execute(\n                select(ComplianceControl)\n                .join(ComplianceDomain)\n                .where(\n                    ComplianceDomain.framework_id == framework.framework_id,\n                    ComplianceControl.control_code == mapping_data[\"control\"],\n                )\n            )\n            control = control.scalar_one_or_none()\n\n            if control:\n                mapping = RuleComplianceMapping(\n                    rule_id=mapping_data[\"rule_id\"],\n                    control_id=control.control_id,\n                    relevance=mapping_data.get(\"relevance\", \"direct\"),\n                )\n                db.add(mapping)\n```\n\n## Supported Frameworks\n\n| Framework | Version | Controls | Coverage |\n|-----------|---------|----------|----------|\n| HIPAA | 2013 | 42 | High |\n| SOC 2 | 2017 | 64 | High |\n| PCI-DSS | 4.0 | 78 | Medium |\n| GDPR | 2018 | 35 | Medium |\n| CIS Benchmarks | AWS 1.5 | 55 | High |\n| NIST 800-53 | Rev 5 | 120 | Medium |\n\n## API Endpoints\n\n```\nGET  /api/v1/compliance/frameworks           # List all frameworks\nGET  /api/v1/compliance/frameworks/:id       # Get framework details\nGET  /api/v1/compliance/status/:framework    # Get compliance status\nGET  /api/v1/compliance/findings/:framework  # Get findings by framework\nGET  /api/v1/compliance/report/:framework    # Generate compliance report\n```\n\n## Files to Create\n\n```\nsrc/cloud_optimizer/services/\n\u2514\u2500\u2500 compliance.py                # Compliance service\n\nsrc/cloud_optimizer/compliance/\n\u251c\u2500\u2500 __init__.py\n\u2514\u2500\u2500 loader.py                    # YAML data loader\n\nsrc/cloud_optimizer/models/\n\u251c\u2500\u2500 compliance_framework.py\n\u251c\u2500\u2500 compliance_domain.py\n\u251c\u2500\u2500 compliance_control.py\n\u2514\u2500\u2500 rule_mapping.py\n\nsrc/cloud_optimizer/api/routers/\n\u2514\u2500\u2500 compliance.py                # API endpoints\n\ndata/compliance/\n\u251c\u2500\u2500 hipaa.yaml\n\u251c\u2500\u2500 soc2.yaml\n\u251c\u2500\u2500 pci-dss.yaml\n\u251c\u2500\u2500 gdpr.yaml\n\u251c\u2500\u2500 cis.yaml\n\u2514\u2500\u2500 nist.yaml\n\nalembic/versions/\n\u2514\u2500\u2500 xxx_create_compliance_tables.py\n\ntests/services/\n\u2514\u2500\u2500 test_compliance.py\n```\n\n## Testing Requirements\n\n### Unit Tests\n- [ ] `test_compliance_loader.py` - YAML parsing and loading\n- [ ] `test_compliance_status.py` - Status calculation\n- [ ] `test_mapping_lookup.py` - Rule to framework mapping\n\n### Integration Tests\n- [ ] `test_compliance_service.py` - Full service with DB\n- [ ] `test_compliance_api.py` - API endpoints\n\n## Acceptance Criteria Checklist\n\n- [ ] 6 compliance frameworks loaded from YAML\n- [ ] Frameworks have domains and controls hierarchy\n- [ ] Security rules mapped to compliance controls\n- [ ] Compliance status calculates % correctly\n- [ ] Findings filterable by framework\n- [ ] Control status shows compliant/non-compliant/not-assessed\n- [ ] Compliance report generates correctly\n- [ ] Chat can answer \"Show HIPAA findings\"\n- [ ] 80%+ test coverage\n\n## Dependencies\n\n- 7.2 Security Scanner (rule IDs for mapping)\n- 7.4 Findings Management (finding queries)\n\n## Blocked By\n\n- 7.4 Findings Management\n\n## Blocks\n\n- 8.3 Security Analysis (compliance-aware responses)\n\n## Estimated Effort\n\n1 week\n\n## Labels\n\n`compliance`, `regulatory`, `data`, `mvp`, `phase-2`, `P0`\n",
  "labels": [
    "mvp",
    "phase-2",
    "P0",
    "data",
    "compliance",
    "regulatory"
  ],
  "assignees": [],
  "milestone": null,
  "created_at": null,
  "updated_at": null,
  "state": "OPEN",
  "context": {
    "complexity": "medium",
    "effort": "medium",
    "confidence": 0.8,
    "required_expertise": [
      "backend",
      "database"
    ],
    "dependencies": [],
    "related_files": []
  },
  "generated_at": "2025-12-04T12:01:57.626442Z",
  "generated_by": "smart-scaffold-cli",
  "branch_name": "feature/issue-33-75complianceframeworkmapping"
}