{
  "issue_number": 25,
  "title": "6.3 Trial Management System",
  "body": "# 6.3 Trial Management System\n\n## Parent Epic\nEpic 6: MVP Phase 1 - Container Product Foundation\n\n## Overview\n\nImplement trial management system that enforces usage limits during the 14-day trial period, provides clear messaging about trial status, and enables smooth conversion to paid subscription.\n\n## Background\n\nTrial customers need to experience Cloud Optimizer's value quickly while staying within defined limits. The trial system must:\n- Track usage against limits (scans, chat questions, documents)\n- Provide clear UI messaging about remaining trial quota\n- Gracefully handle trial expiration\n- Enable easy upgrade path to paid subscription\n\n## Requirements\n\n| ID | Requirement | Acceptance Criteria |\n|----|-------------|---------------------|\n| TRL-001 | Trial creation | Auto-create trial on first access, record start date in DB |\n| TRL-002 | Trial limits | Enforce: 50 scans, 500 chat questions, 20 documents, 1 AWS account |\n| TRL-003 | Trial expiration | Graceful degradation after 14 days, read-only access to existing data |\n| TRL-004 | Trial conversion | Clear upgrade CTA, one-click to AWS Marketplace |\n| TRL-005 | Trial extension | Admin can extend trial by 7 days (one-time) |\n| TRL-006 | Trial notifications | Email/UI notifications at 75%, 90%, 100% of limits and 3 days before expiry |\n\n## Technical Specification\n\n### Trial Configuration\n\n```yaml\ntrial:\n  duration_days: 14\n  extension_days: 7  # One-time extension allowed\n  limits:\n    aws_accounts: 1\n    scans_per_day: 5\n    total_scans: 50\n    chat_questions_per_day: 50\n    total_chat_questions: 500\n    document_uploads: 20\n    findings_stored: 500\n    users: 1\n\n  features_enabled:\n    - security_chat_qa\n    - document_analysis\n    - security_scanning\n    - cost_analysis_basic\n    - compliance_recommendations\n\n  features_disabled:\n    - advanced_analytics\n    - custom_reports\n    - api_access\n    - multi_account\n    - scheduled_scans\n```\n\n### Database Schema\n\n```sql\n-- Trial tracking table\nCREATE TABLE trials (\n    trial_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    tenant_id UUID NOT NULL REFERENCES tenants(tenant_id),\n    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    expires_at TIMESTAMPTZ NOT NULL,\n    extended_at TIMESTAMPTZ,  -- NULL if not extended\n    converted_at TIMESTAMPTZ,  -- NULL if not converted\n    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- active, expired, converted\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\n-- Usage tracking table\nCREATE TABLE trial_usage (\n    usage_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    trial_id UUID NOT NULL REFERENCES trials(trial_id),\n    dimension VARCHAR(50) NOT NULL,  -- scans, chat_questions, documents\n    count INTEGER NOT NULL DEFAULT 0,\n    last_reset_at TIMESTAMPTZ,  -- For daily limits\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    UNIQUE(trial_id, dimension)\n);\n\n-- Indexes\nCREATE INDEX idx_trials_tenant ON trials(tenant_id);\nCREATE INDEX idx_trials_status ON trials(status);\nCREATE INDEX idx_trial_usage_trial ON trial_usage(trial_id);\n```\n\n### Trial Service\n\n```python\n# src/cloud_optimizer/services/trial.py\nclass TrialService:\n    def __init__(self, db: AsyncSession, config: TrialConfig):\n        self.db = db\n        self.config = config\n\n    async def get_or_create_trial(self, tenant_id: UUID) -> Trial:\n        \"\"\"Get existing trial or create new one.\"\"\"\n        trial = await self._get_trial(tenant_id)\n        if trial:\n            return trial\n\n        # Create new trial\n        trial = Trial(\n            tenant_id=tenant_id,\n            started_at=datetime.utcnow(),\n            expires_at=datetime.utcnow() + timedelta(days=self.config.duration_days),\n            status=TrialStatus.ACTIVE,\n        )\n        self.db.add(trial)\n        await self.db.commit()\n\n        # Initialize usage counters\n        for dimension in [\"scans\", \"chat_questions\", \"documents\"]:\n            usage = TrialUsage(trial_id=trial.trial_id, dimension=dimension, count=0)\n            self.db.add(usage)\n        await self.db.commit()\n\n        return trial\n\n    async def check_limit(self, tenant_id: UUID, dimension: str) -> TrialLimitCheck:\n        \"\"\"Check if action is allowed within trial limits.\"\"\"\n        trial = await self.get_or_create_trial(tenant_id)\n\n        # Check if trial is active\n        if trial.status == TrialStatus.EXPIRED:\n            return TrialLimitCheck(allowed=False, reason=\"trial_expired\")\n\n        if trial.status == TrialStatus.CONVERTED:\n            return TrialLimitCheck(allowed=True, reason=\"paid_subscription\")\n\n        # Check usage against limit\n        usage = await self._get_usage(trial.trial_id, dimension)\n        limit = self.config.limits.get(f\"total_{dimension}\")\n\n        if usage.count >= limit:\n            return TrialLimitCheck(\n                allowed=False,\n                reason=\"limit_reached\",\n                current=usage.count,\n                limit=limit,\n            )\n\n        return TrialLimitCheck(\n            allowed=True,\n            current=usage.count,\n            limit=limit,\n            remaining=limit - usage.count,\n        )\n\n    async def record_usage(self, tenant_id: UUID, dimension: str, count: int = 1):\n        \"\"\"Record usage of a trial resource.\"\"\"\n        trial = await self.get_or_create_trial(tenant_id)\n\n        await self.db.execute(\n            update(TrialUsage)\n            .where(TrialUsage.trial_id == trial.trial_id)\n            .where(TrialUsage.dimension == dimension)\n            .values(count=TrialUsage.count + count, updated_at=datetime.utcnow())\n        )\n        await self.db.commit()\n\n        # Check for notification thresholds\n        await self._check_notification_thresholds(trial, dimension)\n\n    async def extend_trial(self, tenant_id: UUID) -> Trial:\n        \"\"\"Extend trial by configured days (one-time).\"\"\"\n        trial = await self._get_trial(tenant_id)\n\n        if trial.extended_at is not None:\n            raise TrialAlreadyExtendedException()\n\n        trial.expires_at += timedelta(days=self.config.extension_days)\n        trial.extended_at = datetime.utcnow()\n        await self.db.commit()\n\n        return trial\n\n    async def get_trial_status(self, tenant_id: UUID) -> TrialStatusResponse:\n        \"\"\"Get comprehensive trial status for UI.\"\"\"\n        trial = await self.get_or_create_trial(tenant_id)\n        usage = await self._get_all_usage(trial.trial_id)\n\n        days_remaining = (trial.expires_at - datetime.utcnow()).days\n        days_remaining = max(0, days_remaining)\n\n        return TrialStatusResponse(\n            status=trial.status,\n            started_at=trial.started_at,\n            expires_at=trial.expires_at,\n            days_remaining=days_remaining,\n            can_extend=trial.extended_at is None and trial.status == TrialStatus.ACTIVE,\n            usage={\n                \"scans\": UsageInfo(\n                    current=usage.get(\"scans\", 0),\n                    limit=self.config.limits.total_scans,\n                ),\n                \"chat_questions\": UsageInfo(\n                    current=usage.get(\"chat_questions\", 0),\n                    limit=self.config.limits.total_chat_questions,\n                ),\n                \"documents\": UsageInfo(\n                    current=usage.get(\"documents\", 0),\n                    limit=self.config.limits.document_uploads,\n                ),\n            },\n            upgrade_url=\"https://aws.amazon.com/marketplace/pp/xxx\",\n        )\n```\n\n### Trial Enforcement Middleware\n\n```python\n# src/cloud_optimizer/middleware/trial.py\nclass TrialEnforcementMiddleware:\n    \"\"\"Enforce trial limits on protected endpoints.\"\"\"\n\n    # Map endpoints to usage dimensions\n    METERED_ENDPOINTS = {\n        \"/api/v1/security/scan\": \"scans\",\n        \"/api/v1/chat/message\": \"chat_questions\",\n        \"/api/v1/documents/upload\": \"documents\",\n    }\n\n    async def __call__(self, scope: Scope, receive: Receive, send: Send):\n        if scope[\"type\"] != \"http\":\n            await self.app(scope, receive, send)\n            return\n\n        path = scope[\"path\"]\n\n        # Check if endpoint is metered\n        dimension = self._get_dimension(path)\n        if dimension:\n            tenant_id = scope[\"state\"].get(\"tenant_id\")\n            check = await self.trial_service.check_limit(tenant_id, dimension)\n\n            if not check.allowed:\n                response = JSONResponse(\n                    status_code=429,\n                    content={\n                        \"error\": \"trial_limit_exceeded\",\n                        \"dimension\": dimension,\n                        \"current\": check.current,\n                        \"limit\": check.limit,\n                        \"message\": f\"Trial limit reached for {dimension}. Please upgrade.\",\n                        \"upgrade_url\": \"https://aws.amazon.com/marketplace/pp/xxx\",\n                    },\n                )\n                await response(scope, receive, send)\n                return\n\n        await self.app(scope, receive, send)\n```\n\n## Files to Create\n\n```\nsrc/cloud_optimizer/services/\n\u2514\u2500\u2500 trial.py                 # Trial management service\n\nsrc/cloud_optimizer/models/\n\u2514\u2500\u2500 trial.py                 # Trial SQLAlchemy models\n\nsrc/cloud_optimizer/middleware/\n\u2514\u2500\u2500 trial.py                 # Trial enforcement middleware\n\nsrc/cloud_optimizer/api/routers/\n\u2514\u2500\u2500 trial.py                 # Trial status API endpoints\n\nalembic/versions/\n\u2514\u2500\u2500 xxx_create_trial_tables.py  # Migration\n\ntests/services/\n\u2514\u2500\u2500 test_trial.py            # Trial service tests\n```\n\n## API Endpoints\n\n```\nGET  /api/v1/trial/status     # Get trial status and usage\nPOST /api/v1/trial/extend     # Extend trial (one-time)\n```\n\n## Testing Requirements\n\n### Unit Tests\n- [ ] `test_trial_creation.py` - New trial created correctly\n- [ ] `test_trial_limits.py` - Limits enforced correctly\n- [ ] `test_trial_expiration.py` - Expired trials handled\n- [ ] `test_trial_extension.py` - Extension works once only\n- [ ] `test_usage_recording.py` - Usage tracked correctly\n\n### Integration Tests\n- [ ] `test_trial_flow.py` - Full trial lifecycle\n- [ ] `test_limit_enforcement.py` - API returns 429 at limit\n\n## Acceptance Criteria Checklist\n\n- [ ] Trial auto-created on first access\n- [ ] Usage tracked for scans, chat questions, documents\n- [ ] API returns 429 when limit reached\n- [ ] Trial expires after 14 days\n- [ ] Expired trial allows read-only access\n- [ ] Extension adds 7 days (one-time only)\n- [ ] Trial status endpoint returns accurate data\n- [ ] UI can display trial status from endpoint\n- [ ] 80%+ test coverage\n\n## Dependencies\n\n- 6.2 AWS Marketplace Integration (license status)\n\n## Blocked By\n\n- 6.2 AWS Marketplace Integration\n\n## Blocks\n\n- 6.5 Chat Interface UI (needs trial status API)\n\n## Estimated Effort\n\n0.5 weeks\n\n## Labels\n\n`trial`, `billing`, `mvp`, `phase-1`, `P0`\n",
  "labels": [
    "mvp",
    "phase-1",
    "P0",
    "billing",
    "trial"
  ],
  "assignees": [],
  "milestone": null,
  "created_at": null,
  "updated_at": null,
  "state": "OPEN",
  "context": {
    "complexity": "medium",
    "effort": "medium",
    "confidence": 0.8,
    "required_expertise": [
      "backend",
      "database"
    ],
    "dependencies": [],
    "related_files": []
  },
  "generated_at": "2025-12-04T10:22:47.606617Z",
  "generated_by": "smart-scaffold-cli",
  "branch_name": "feature/issue-25-63trialmanagementsystem"
}