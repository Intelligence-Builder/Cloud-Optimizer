{
  "issue_number": 29,
  "title": "7.1 AWS Account Connection",
  "body": "# 7.1 AWS Account Connection\n\n## Parent Epic\nEpic 7: MVP Phase 2 - Security & Cost Scanning\n\n## Overview\n\nImplement secure AWS account connection that allows trial customers to connect their AWS account for scanning. Uses IAM roles with read-only permissions to ensure customer data security and follows AWS best practices for cross-account access.\n\n## Background\n\nTrial customers need to connect their AWS account to Cloud Optimizer for scanning. The connection must:\n- Use least-privilege IAM permissions (read-only)\n- Support cross-account access via IAM roles (preferred) or access keys\n- Validate credentials before storing\n- Encrypt credentials at rest\n- Support easy disconnection\n\n## Requirements\n\n| ID | Requirement | Acceptance Criteria |\n|----|-------------|---------------------|\n| AWS-001 | Account connection | Support IAM role ARN (preferred) and access keys |\n| AWS-002 | Credential validation | Validate credentials via STS GetCallerIdentity before storing |\n| AWS-003 | Permission verification | Verify required permissions before accepting connection |\n| AWS-004 | Secure storage | Encrypt credentials with AWS KMS or Fernet, never log credentials |\n\n## Technical Specification\n\n### IAM Role Policy (Customer Creates)\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"CloudOptimizerReadOnly\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetBucketPolicy\",\n        \"s3:GetBucketEncryption\",\n        \"s3:GetBucketPublicAccessBlock\",\n        \"s3:GetBucketVersioning\",\n        \"s3:GetBucketLogging\",\n        \"s3:ListAllMyBuckets\",\n        \"ec2:Describe*\",\n        \"rds:Describe*\",\n        \"iam:GetAccountPasswordPolicy\",\n        \"iam:ListUsers\",\n        \"iam:ListRoles\",\n        \"iam:ListPolicies\",\n        \"iam:GetPolicy\",\n        \"iam:GetPolicyVersion\",\n        \"iam:ListAccessKeys\",\n        \"iam:GetAccessKeyLastUsed\",\n        \"cloudtrail:DescribeTrails\",\n        \"cloudtrail:GetTrailStatus\",\n        \"config:DescribeConfigurationRecorders\",\n        \"kms:ListKeys\",\n        \"kms:GetKeyPolicy\",\n        \"kms:DescribeKey\",\n        \"ce:GetCostAndUsage\",\n        \"ce:GetReservationUtilization\",\n        \"ce:GetSavingsPlansPurchaseRecommendation\",\n        \"support:DescribeTrustedAdvisorChecks\",\n        \"support:DescribeTrustedAdvisorCheckResult\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\n```\n\n### Trust Policy (for IAM Role)\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::CLOUD_OPTIMIZER_ACCOUNT:root\"\n      },\n      \"Action\": \"sts:AssumeRole\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"sts:ExternalId\": \"${TENANT_EXTERNAL_ID}\"\n        }\n      }\n    }\n  ]\n}\n```\n\n### Database Schema\n\n```sql\n-- AWS account connections\nCREATE TABLE aws_accounts (\n    account_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    tenant_id UUID NOT NULL REFERENCES tenants(tenant_id),\n    aws_account_id VARCHAR(12) NOT NULL,  -- 12-digit AWS account ID\n    friendly_name VARCHAR(255),\n    connection_type VARCHAR(20) NOT NULL,  -- 'iam_role' or 'access_keys'\n\n    -- For IAM role connection\n    role_arn VARCHAR(2048),\n    external_id VARCHAR(255),  -- Per-tenant external ID for security\n\n    -- For access key connection (encrypted)\n    access_key_id_encrypted BYTEA,\n    secret_access_key_encrypted BYTEA,\n\n    -- Connection status\n    status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending, active, error, disconnected\n    last_validated_at TIMESTAMPTZ,\n    last_error TEXT,\n\n    -- Metadata\n    region VARCHAR(20) NOT NULL DEFAULT 'us-east-1',\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n\n    UNIQUE(tenant_id, aws_account_id)\n);\n\nCREATE INDEX idx_aws_accounts_tenant ON aws_accounts(tenant_id);\nCREATE INDEX idx_aws_accounts_status ON aws_accounts(status);\n```\n\n### AWS Connection Service\n\n```python\n# src/cloud_optimizer/services/aws_connection.py\nfrom cryptography.fernet import Fernet\nimport boto3\n\nclass AWSConnectionService:\n    def __init__(self, db: AsyncSession, encryption_key: str):\n        self.db = db\n        self.fernet = Fernet(encryption_key.encode())\n\n    async def connect_with_role(\n        self,\n        tenant_id: UUID,\n        role_arn: str,\n        external_id: str,\n        friendly_name: str = None,\n    ) -> AWSAccount:\n        \"\"\"Connect AWS account using IAM role.\"\"\"\n        # Validate role ARN format\n        if not self._validate_role_arn(role_arn):\n            raise InvalidRoleARNException()\n\n        # Extract AWS account ID from ARN\n        aws_account_id = self._extract_account_id(role_arn)\n\n        # Check trial limit (1 AWS account for trial)\n        await self._check_account_limit(tenant_id)\n\n        # Validate connection by assuming role\n        try:\n            credentials = await self._assume_role(role_arn, external_id)\n            await self._verify_permissions(credentials)\n        except Exception as e:\n            raise AWSConnectionException(f\"Failed to connect: {str(e)}\")\n\n        # Store connection\n        account = AWSAccount(\n            tenant_id=tenant_id,\n            aws_account_id=aws_account_id,\n            friendly_name=friendly_name or f\"AWS {aws_account_id}\",\n            connection_type=\"iam_role\",\n            role_arn=role_arn,\n            external_id=external_id,\n            status=\"active\",\n            last_validated_at=datetime.utcnow(),\n        )\n        self.db.add(account)\n        await self.db.commit()\n\n        return account\n\n    async def connect_with_keys(\n        self,\n        tenant_id: UUID,\n        access_key_id: str,\n        secret_access_key: str,\n        friendly_name: str = None,\n    ) -> AWSAccount:\n        \"\"\"Connect AWS account using access keys (less secure).\"\"\"\n        # Check trial limit\n        await self._check_account_limit(tenant_id)\n\n        # Validate credentials\n        try:\n            session = boto3.Session(\n                aws_access_key_id=access_key_id,\n                aws_secret_access_key=secret_access_key,\n            )\n            sts = session.client(\"sts\")\n            identity = sts.get_caller_identity()\n            aws_account_id = identity[\"Account\"]\n\n            # Verify required permissions\n            await self._verify_permissions_with_session(session)\n        except Exception as e:\n            raise AWSConnectionException(f\"Invalid credentials: {str(e)}\")\n\n        # Encrypt credentials\n        encrypted_key_id = self.fernet.encrypt(access_key_id.encode())\n        encrypted_secret = self.fernet.encrypt(secret_access_key.encode())\n\n        # Store connection\n        account = AWSAccount(\n            tenant_id=tenant_id,\n            aws_account_id=aws_account_id,\n            friendly_name=friendly_name or f\"AWS {aws_account_id}\",\n            connection_type=\"access_keys\",\n            access_key_id_encrypted=encrypted_key_id,\n            secret_access_key_encrypted=encrypted_secret,\n            status=\"active\",\n            last_validated_at=datetime.utcnow(),\n        )\n        self.db.add(account)\n        await self.db.commit()\n\n        return account\n\n    async def _assume_role(self, role_arn: str, external_id: str) -> dict:\n        \"\"\"Assume IAM role and return temporary credentials.\"\"\"\n        sts = boto3.client(\"sts\")\n        response = sts.assume_role(\n            RoleArn=role_arn,\n            RoleSessionName=\"CloudOptimizerScan\",\n            ExternalId=external_id,\n            DurationSeconds=3600,\n        )\n        return response[\"Credentials\"]\n\n    async def _verify_permissions(self, credentials: dict) -> bool:\n        \"\"\"Verify the role has required permissions.\"\"\"\n        session = boto3.Session(\n            aws_access_key_id=credentials[\"AccessKeyId\"],\n            aws_secret_access_key=credentials[\"SecretAccessKey\"],\n            aws_session_token=credentials[\"SessionToken\"],\n        )\n\n        required_checks = [\n            (\"s3\", \"list_buckets\", {}),\n            (\"ec2\", \"describe_instances\", {}),\n            (\"iam\", \"get_account_password_policy\", {}),\n        ]\n\n        for service, method, params in required_checks:\n            try:\n                client = session.client(service)\n                getattr(client, method)(**params)\n            except client.exceptions.ClientError as e:\n                if e.response[\"Error\"][\"Code\"] == \"AccessDenied\":\n                    raise InsufficientPermissionsException(\n                        f\"Missing permission for {service}:{method}\"\n                    )\n                raise\n\n        return True\n\n    async def get_session(self, account_id: UUID) -> boto3.Session:\n        \"\"\"Get boto3 session for connected account.\"\"\"\n        account = await self._get_account(account_id)\n\n        if account.connection_type == \"iam_role\":\n            credentials = await self._assume_role(\n                account.role_arn, account.external_id\n            )\n            return boto3.Session(\n                aws_access_key_id=credentials[\"AccessKeyId\"],\n                aws_secret_access_key=credentials[\"SecretAccessKey\"],\n                aws_session_token=credentials[\"SessionToken\"],\n            )\n        else:\n            access_key_id = self.fernet.decrypt(\n                account.access_key_id_encrypted\n            ).decode()\n            secret_key = self.fernet.decrypt(\n                account.secret_access_key_encrypted\n            ).decode()\n            return boto3.Session(\n                aws_access_key_id=access_key_id,\n                aws_secret_access_key=secret_key,\n            )\n\n    async def disconnect(self, tenant_id: UUID, account_id: UUID):\n        \"\"\"Disconnect AWS account.\"\"\"\n        await self.db.execute(\n            update(AWSAccount)\n            .where(AWSAccount.account_id == account_id)\n            .where(AWSAccount.tenant_id == tenant_id)\n            .values(\n                status=\"disconnected\",\n                access_key_id_encrypted=None,\n                secret_access_key_encrypted=None,\n                updated_at=datetime.utcnow(),\n            )\n        )\n        await self.db.commit()\n```\n\n## API Endpoints\n\n```\nPOST /api/v1/aws/connect/role        # Connect with IAM role\nPOST /api/v1/aws/connect/keys        # Connect with access keys\nGET  /api/v1/aws/accounts            # List connected accounts\nGET  /api/v1/aws/accounts/:id        # Get account details\nPOST /api/v1/aws/accounts/:id/validate  # Re-validate connection\nDELETE /api/v1/aws/accounts/:id      # Disconnect account\nGET  /api/v1/aws/setup-instructions  # Get IAM policy/trust policy templates\n```\n\n## Files to Create\n\n```\nsrc/cloud_optimizer/services/\n\u2514\u2500\u2500 aws_connection.py            # AWS connection service\n\nsrc/cloud_optimizer/models/\n\u2514\u2500\u2500 aws_account.py               # AWSAccount model\n\nsrc/cloud_optimizer/api/routers/\n\u2514\u2500\u2500 aws.py                       # AWS connection endpoints\n\nalembic/versions/\n\u2514\u2500\u2500 xxx_create_aws_accounts.py   # Migration\n\ndata/iam/\n\u251c\u2500\u2500 policy.json                  # IAM policy template\n\u2514\u2500\u2500 trust-policy.json            # Trust policy template\n\ntests/services/\n\u2514\u2500\u2500 test_aws_connection.py       # Connection service tests\n```\n\n## Testing Requirements\n\n### Unit Tests\n- [ ] `test_role_arn_validation.py` - ARN format validation\n- [ ] `test_credential_encryption.py` - Fernet encryption/decryption\n- [ ] `test_permission_verification.py` - Permission check logic\n\n### Integration Tests\n- [ ] `test_aws_connection_role.py` - Full role connection flow (LocalStack)\n- [ ] `test_aws_connection_keys.py` - Access key flow (LocalStack)\n- [ ] `test_session_creation.py` - Session creation for scanning\n\n### Mocking Strategy\n\n```python\n# tests/services/conftest.py\n@pytest.fixture\ndef mock_sts_client():\n    with patch(\"boto3.client\") as mock:\n        client = MagicMock()\n        client.assume_role.return_value = {\n            \"Credentials\": {\n                \"AccessKeyId\": \"ASIA...\",\n                \"SecretAccessKey\": \"secret\",\n                \"SessionToken\": \"token\",\n                \"Expiration\": datetime.utcnow() + timedelta(hours=1),\n            }\n        }\n        client.get_caller_identity.return_value = {\n            \"Account\": \"123456789012\",\n            \"Arn\": \"arn:aws:iam::123456789012:user/test\",\n        }\n        mock.return_value = client\n        yield client\n```\n\n## Acceptance Criteria Checklist\n\n- [ ] User can connect AWS account with IAM role ARN\n- [ ] User can connect AWS account with access keys\n- [ ] Credentials validated via STS before storing\n- [ ] Required permissions verified before accepting connection\n- [ ] Access keys encrypted at rest (Fernet)\n- [ ] Role ARN stored (not encrypted, not sensitive)\n- [ ] External ID generated per-tenant\n- [ ] Trial limit enforced (1 account)\n- [ ] User can disconnect account\n- [ ] Disconnection clears encrypted credentials\n- [ ] Setup instructions provided via API\n- [ ] 80%+ test coverage\n\n## Security Considerations\n\n1. **Credential Storage**:\n   - Access keys encrypted with Fernet (AES-128-CBC)\n   - Encryption key stored in AWS Secrets Manager (not in env vars)\n   - Role ARNs not encrypted (not sensitive)\n\n2. **Least Privilege**:\n   - Read-only permissions only\n   - No write/delete permissions on customer resources\n   - External ID prevents confused deputy attacks\n\n3. **Audit Logging**:\n   - Log all connection/disconnection events\n   - Log scan initiations (not results)\n   - Never log credentials or decrypted values\n\n## Dependencies\n\n- 6.4 Basic Authentication (user context)\n- 6.3 Trial Management (account limit check)\n\n## Blocked By\n\n- 6.4 Basic Authentication\n\n## Blocks\n\n- 7.2 Security Scanner (needs AWS session)\n- 7.3 Cost Scanner (needs AWS session)\n\n## Estimated Effort\n\n1 week\n\n## Labels\n\n`aws`, `security`, `connection`, `mvp`, `phase-2`, `P0`\n",
  "labels": [
    "security",
    "mvp",
    "phase-2",
    "P0",
    "aws",
    "connection"
  ],
  "assignees": [],
  "milestone": null,
  "created_at": null,
  "updated_at": null,
  "state": "OPEN",
  "context": {
    "complexity": "medium",
    "effort": "medium",
    "confidence": 0.8,
    "required_expertise": [
      "backend",
      "database",
      "security"
    ],
    "dependencies": [],
    "related_files": []
  },
  "generated_at": "2025-12-03T21:14:53.325149Z",
  "generated_by": "smart-scaffold-cli",
  "branch_name": "feature/issue-29-71awsaccountconnection"
}