{
  "issue_number": 23,
  "title": "6.1 Container Packaging",
  "body": "# 6.1 Container Packaging\n\n## Parent Epic\nEpic 6: MVP Phase 1 - Container Product Foundation\n\n## Overview\n\nCreate a production-ready Docker container that bundles Cloud Optimizer (CO) and Intelligence-Builder (IB) into a single deployable image. The container must support one-click deployment via CloudFormation and work with AWS Marketplace.\n\n## Background\n\nCloud Optimizer is deployed as an **AWS Marketplace Container Product**. CO and IB are bundled together because:\n1. Simplified deployment (one container vs. orchestrating multiple)\n2. Version synchronization guaranteed\n3. Reduced network latency (IB is embedded library)\n4. Easier for trial customers to deploy\n\n## Requirements\n\n| ID | Requirement | Acceptance Criteria |\n|----|-------------|---------------------|\n| CNT-001 | Docker image packaging | Multi-stage Dockerfile, <500MB image, passes Trivy security scan |\n| CNT-002 | Helm chart | Configurable values.yaml, works on EKS, documented |\n| CNT-003 | CloudFormation template | One-click deploy with RDS, VPC auto-configuration, <10min setup |\n| CNT-004 | Container health checks | Liveness probe at /health, readiness probe, checks DB + IB |\n| CNT-005 | Environment configuration | All secrets via AWS Secrets Manager, configmaps for non-secrets |\n| CNT-006 | Upgrade mechanism | Zero-downtime updates, automatic DB migrations, rollback capability |\n\n## Technical Specification\n\n### Dockerfile Structure\n\n```dockerfile\n# Stage 1: Build\nFROM python:3.11-slim as builder\nWORKDIR /app\nCOPY pyproject.toml poetry.lock ./\nRUN pip install poetry && poetry export -f requirements.txt > requirements.txt\nCOPY src/ ./src/\nRUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements.txt\n\n# Stage 2: Runtime\nFROM python:3.11-slim as runtime\nRUN useradd -m -u 1000 appuser\nWORKDIR /app\nCOPY --from=builder /wheels /wheels\nRUN pip install --no-cache-dir /wheels/*\nCOPY src/ ./src/\nCOPY alembic/ ./alembic/\nCOPY data/compliance/ ./data/compliance/  # Baked-in compliance KB\nUSER appuser\nEXPOSE 8000\nHEALTHCHECK --interval=30s --timeout=10s --start-period=60s \\\n  CMD curl -f http://localhost:8000/health || exit 1\nENTRYPOINT [\"python\", \"-m\", \"cloud_optimizer.entrypoint\"]\n```\n\n### Entrypoint Script\n\n```python\n# src/cloud_optimizer/entrypoint.py\nasync def main():\n    # 1. Validate environment\n    validate_required_env_vars()\n\n    # 2. Wait for database\n    await wait_for_database(timeout=60)\n\n    # 3. Run migrations (IB schema first, then CO)\n    await run_migrations()\n\n    # 4. Initialize IB Platform\n    ib_platform = await initialize_ib_platform()\n\n    # 5. Load compliance knowledge base\n    await load_compliance_kb()\n\n    # 6. Validate Marketplace license (if enabled)\n    license_status = await validate_marketplace_license()\n\n    # 7. Start FastAPI app\n    app = create_app(ib_platform=ib_platform, license_status=license_status)\n\n    # 8. Run with uvicorn\n    config = uvicorn.Config(app, host=\"0.0.0.0\", port=8000)\n    server = uvicorn.Server(config)\n    await server.serve()\n```\n\n### Health Check Endpoint\n\n```python\n@router.get(\"/health\")\nasync def health_check(db: AsyncSession = Depends(get_db)):\n    components = {\n        \"database\": await check_database(db),\n        \"ib_platform\": await check_ib_platform(),\n        \"redis\": await check_redis() if settings.REDIS_URL else \"disabled\",\n    }\n\n    status = \"healthy\" if all(v == \"ok\" for v in components.values() if v != \"disabled\") else \"unhealthy\"\n\n    return {\n        \"status\": status,\n        \"version\": settings.VERSION,\n        \"components\": components,\n        \"timestamp\": datetime.utcnow().isoformat(),\n    }\n```\n\n## Files to Create\n\n```\ndocker/\n\u251c\u2500\u2500 Dockerfile                    # Multi-stage production build\n\u251c\u2500\u2500 Dockerfile.dev               # Development with hot reload\n\u251c\u2500\u2500 docker-compose.yml           # Local development stack\n\u251c\u2500\u2500 docker-compose.test.yml      # Integration test stack\n\u251c\u2500\u2500 .dockerignore\n\u2514\u2500\u2500 entrypoint.sh                # Shell wrapper for entrypoint\n\nhelm/cloud-optimizer/\n\u251c\u2500\u2500 Chart.yaml\n\u251c\u2500\u2500 values.yaml\n\u251c\u2500\u2500 values-dev.yaml\n\u251c\u2500\u2500 values-prod.yaml\n\u251c\u2500\u2500 templates/\n\u2502   \u251c\u2500\u2500 deployment.yaml\n\u2502   \u251c\u2500\u2500 service.yaml\n\u2502   \u251c\u2500\u2500 configmap.yaml\n\u2502   \u251c\u2500\u2500 secret.yaml\n\u2502   \u251c\u2500\u2500 ingress.yaml\n\u2502   \u251c\u2500\u2500 hpa.yaml\n\u2502   \u2514\u2500\u2500 _helpers.tpl\n\u2514\u2500\u2500 README.md\n\ncloudformation/\n\u251c\u2500\u2500 cloud-optimizer-quickstart.yaml    # One-click trial deploy\n\u251c\u2500\u2500 cloud-optimizer-production.yaml    # Production deploy\n\u251c\u2500\u2500 nested/\n\u2502   \u251c\u2500\u2500 vpc.yaml\n\u2502   \u251c\u2500\u2500 ecs.yaml\n\u2502   \u251c\u2500\u2500 rds.yaml\n\u2502   \u2514\u2500\u2500 alb.yaml\n\u2514\u2500\u2500 parameters/\n    \u251c\u2500\u2500 trial.json\n    \u2514\u2500\u2500 production.json\n\nsrc/cloud_optimizer/\n\u251c\u2500\u2500 entrypoint.py                # Application entrypoint\n\u2514\u2500\u2500 health.py                    # Health check endpoints\n```\n\n## Files to Modify\n\n```\npyproject.toml                   # Add Docker-related dependencies\nsrc/cloud_optimizer/config.py    # Environment variable handling\nalembic/env.py                   # Migration configuration\n```\n\n## Testing Requirements\n\n### Unit Tests\n- [ ] `test_entrypoint.py` - Startup sequence, error handling\n- [ ] `test_health.py` - Health check responses, component status\n\n### Integration Tests\n- [ ] `test_container_build.py` - Docker build succeeds, image size <500MB\n- [ ] `test_container_startup.py` - Container starts, health check passes\n- [ ] `test_migrations.py` - Migrations run successfully on fresh DB\n\n### E2E Tests\n- [ ] `test_cloudformation_deploy.py` - Template deploys successfully (LocalStack)\n- [ ] `test_helm_install.py` - Helm chart installs on kind cluster\n\n## Acceptance Criteria Checklist\n\n- [ ] Docker image builds successfully with `docker build`\n- [ ] Image size is <500MB\n- [ ] Trivy security scan passes with no HIGH/CRITICAL vulnerabilities\n- [ ] Container starts and `/health` returns 200 within 60 seconds\n- [ ] CloudFormation template validates (`aws cloudformation validate-template`)\n- [ ] CloudFormation creates stack successfully in test account\n- [ ] Helm chart installs on local kind cluster\n- [ ] Database migrations run automatically on first startup\n- [ ] Container restarts cleanly after crash (migrations are idempotent)\n- [ ] All secrets loaded from AWS Secrets Manager (no hardcoded values)\n- [ ] 80%+ test coverage on new code\n\n## Dependencies\n\n- None (first issue in epic)\n\n## Blocked By\n\n- None\n\n## Blocks\n\n- 6.2 AWS Marketplace Integration (needs container image)\n- 6.5 Chat Interface UI (needs running backend)\n\n## Estimated Effort\n\n1.5 weeks\n\n## Labels\n\n`container`, `infrastructure`, `mvp`, `phase-1`, `P0`\n\n## Reference Documents\n\n- [DEPLOYMENT.md](../04-operations/DEPLOYMENT.md) - Container architecture details\n- [PHASED_IMPLEMENTATION_PLAN.md](../02-architecture/PHASED_IMPLEMENTATION_PLAN.md) - Dockerfile example\n",
  "labels": [
    "mvp",
    "phase-1",
    "P0",
    "container",
    "infrastructure"
  ],
  "assignees": [],
  "milestone": null,
  "created_at": null,
  "updated_at": null,
  "state": "OPEN",
  "context": {
    "complexity": "medium",
    "effort": "medium",
    "confidence": 0.8,
    "required_expertise": [
      "backend",
      "database"
    ],
    "dependencies": [],
    "related_files": []
  },
  "generated_at": "2025-12-03T18:22:26.814160Z",
  "generated_by": "smart-scaffold-cli",
  "branch_name": "feature/issue-23-61containerpackaging"
}