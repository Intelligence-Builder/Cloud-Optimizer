{
  "issue_number": 39,
  "title": "8.5 Knowledge Base Integration",
  "body": "# 8.5 Knowledge Base Integration\n\n## Parent Epic\nEpic 8: MVP Phase 2 - Expert System (Intelligence-Builder)\n\n## Overview\n\nImplement the compliance knowledge base that provides expert-level security guidance for answer generation. The KB contains compliance framework requirements, AWS security best practices, and remediation patterns baked into the container.\n\n## Background\n\nThe knowledge base enables expert-level responses without real-time web searches:\n- Compliance requirements (HIPAA, SOC2, PCI-DSS, GDPR, CIS, NIST)\n- AWS service security best practices\n- Common misconfiguration patterns\n- Remediation code templates\n- All baked into container at build time\n\n## Requirements\n\n| ID | Requirement | Acceptance Criteria |\n|----|-------------|---------------------|\n| KB-001 | KB structure | Organize by framework, service, pattern type |\n| KB-002 | KB loading | Load from YAML files at startup, cache in memory |\n| KB-003 | KB queries | Query by framework, service, or pattern |\n\n## Technical Specification\n\n### Knowledge Base Structure\n\n```\ndata/compliance/\n\u251c\u2500\u2500 frameworks/\n\u2502   \u251c\u2500\u2500 hipaa/\n\u2502   \u2502   \u251c\u2500\u2500 controls.yaml       # All HIPAA controls\n\u2502   \u2502   \u251c\u2500\u2500 aws_mappings.yaml   # AWS services to controls\n\u2502   \u2502   \u2514\u2500\u2500 requirements.yaml   # Detailed requirements\n\u2502   \u251c\u2500\u2500 soc2/\n\u2502   \u251c\u2500\u2500 pci-dss/\n\u2502   \u251c\u2500\u2500 gdpr/\n\u2502   \u251c\u2500\u2500 cis/\n\u2502   \u2514\u2500\u2500 nist/\n\u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 s3.yaml                 # S3 security best practices\n\u2502   \u251c\u2500\u2500 ec2.yaml\n\u2502   \u251c\u2500\u2500 rds.yaml\n\u2502   \u251c\u2500\u2500 iam.yaml\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 patterns/\n\u2502   \u251c\u2500\u2500 encryption.yaml         # Encryption patterns\n\u2502   \u251c\u2500\u2500 access_control.yaml\n\u2502   \u251c\u2500\u2500 logging.yaml\n\u2502   \u2514\u2500\u2500 network_security.yaml\n\u2514\u2500\u2500 remediation/\n    \u251c\u2500\u2500 terraform/\n    \u2502   \u251c\u2500\u2500 s3_encryption.tf\n    \u2502   \u2514\u2500\u2500 ...\n    \u2514\u2500\u2500 cli/\n        \u251c\u2500\u2500 s3_encryption.sh\n        \u2514\u2500\u2500 ...\n```\n\n### KB Data Models\n\n```python\n# src/ib_platform/kb/models.py\nfrom dataclasses import dataclass, field\nfrom typing import Optional\n\n@dataclass\nclass ComplianceControl:\n    framework: str\n    control_id: str\n    name: str\n    description: str\n    requirements: list[str]\n    aws_services: list[str]\n    implementation_guidance: str\n\n\n@dataclass\nclass ServiceBestPractice:\n    service: str\n    category: str  # encryption, access_control, logging, etc.\n    title: str\n    description: str\n    compliance_frameworks: list[str]\n    implementation: str\n    terraform_example: Optional[str] = None\n    cli_example: Optional[str] = None\n    console_steps: Optional[list[str]] = None\n\n\n@dataclass\nclass SecurityPattern:\n    pattern_id: str\n    name: str\n    category: str\n    description: str\n    applicable_services: list[str]\n    compliance_frameworks: list[str]\n    implementation_steps: list[str]\n    code_examples: dict[str, str]  # language -> code\n\n\n@dataclass\nclass RemediationTemplate:\n    template_id: str\n    rule_id: str  # Maps to scanner rule\n    title: str\n    description: str\n    terraform: Optional[str] = None\n    cli: Optional[str] = None\n    console_steps: Optional[list[str]] = None\n```\n\n### Sample KB Content\n\n```yaml\n# data/compliance/frameworks/hipaa/controls.yaml\nframework: HIPAA\nversion: \"2013\"\ncontrols:\n  - control_id: \"164.312(a)(1)\"\n    name: Access Control\n    description: |\n      Implement technical policies and procedures for electronic information\n      systems that maintain ePHI to allow access only to authorized persons.\n    requirements:\n      - Unique User Identification\n      - Emergency Access Procedure\n      - Automatic Logoff\n      - Encryption and Decryption\n    aws_services:\n      - IAM\n      - KMS\n      - S3\n      - RDS\n    implementation_guidance: |\n      1. Use IAM for user authentication and authorization\n      2. Implement MFA for all users with ePHI access\n      3. Enable CloudTrail for access logging\n      4. Use KMS for encryption key management\n      5. Enable default encryption on S3 and RDS\n\n  - control_id: \"164.312(a)(2)(iv)\"\n    name: Encryption and Decryption\n    description: |\n      Implement a mechanism to encrypt and decrypt electronic protected\n      health information.\n    requirements:\n      - Data at rest encryption\n      - Data in transit encryption\n    aws_services:\n      - KMS\n      - S3\n      - RDS\n      - EBS\n    implementation_guidance: |\n      1. Use SSE-KMS for S3 bucket encryption\n      2. Enable RDS encryption with KMS CMK\n      3. Enable EBS volume encryption\n      4. Use TLS 1.2+ for all data in transit\n\n\n# data/compliance/services/s3.yaml\nservice: S3\nbest_practices:\n  - category: encryption\n    title: Enable Default Encryption\n    description: |\n      All S3 buckets should have default encryption enabled to ensure\n      data at rest is protected.\n    compliance_frameworks:\n      - HIPAA\n      - SOC2\n      - PCI-DSS\n    implementation: |\n      Enable SSE-S3 (AES-256) or SSE-KMS (customer managed keys) as\n      default encryption for all buckets.\n    terraform_example: |\n      resource \"aws_s3_bucket_server_side_encryption_configuration\" \"example\" {\n        bucket = aws_s3_bucket.example.id\n        rule {\n          apply_server_side_encryption_by_default {\n            sse_algorithm     = \"aws:kms\"\n            kms_master_key_id = aws_kms_key.example.arn\n          }\n        }\n      }\n    cli_example: |\n      aws s3api put-bucket-encryption \\\n        --bucket my-bucket \\\n        --server-side-encryption-configuration '{\n          \"Rules\": [{\n            \"ApplyServerSideEncryptionByDefault\": {\n              \"SSEAlgorithm\": \"aws:kms\",\n              \"KMSMasterKeyID\": \"alias/my-key\"\n            }\n          }]\n        }'\n    console_steps:\n      - Navigate to S3 console\n      - Select the bucket\n      - Go to Properties tab\n      - Under Default encryption, click Edit\n      - Select SSE-KMS and choose your KMS key\n      - Save changes\n\n  - category: access_control\n    title: Block Public Access\n    description: |\n      Enable S3 Block Public Access at account and bucket level to\n      prevent accidental public exposure.\n    compliance_frameworks:\n      - HIPAA\n      - SOC2\n      - PCI-DSS\n      - GDPR\n    implementation: |\n      Enable all four Block Public Access settings at both account\n      and bucket levels.\n```\n\n### Knowledge Base Service\n\n```python\n# src/ib_platform/kb/service.py\nimport yaml\nfrom pathlib import Path\nfrom functools import lru_cache\n\nclass KnowledgeBaseService:\n    DATA_DIR = Path(\"data/compliance\")\n\n    def __init__(self):\n        self._frameworks: dict[str, list[ComplianceControl]] = {}\n        self._services: dict[str, list[ServiceBestPractice]] = {}\n        self._patterns: dict[str, SecurityPattern] = {}\n        self._remediation: dict[str, RemediationTemplate] = {}\n\n    async def load(self):\n        \"\"\"Load all KB data at startup.\"\"\"\n        await self._load_frameworks()\n        await self._load_services()\n        await self._load_patterns()\n        await self._load_remediation()\n\n    async def _load_frameworks(self):\n        \"\"\"Load compliance frameworks.\"\"\"\n        frameworks_dir = self.DATA_DIR / \"frameworks\"\n        for framework_dir in frameworks_dir.iterdir():\n            if framework_dir.is_dir():\n                controls_file = framework_dir / \"controls.yaml\"\n                if controls_file.exists():\n                    data = yaml.safe_load(controls_file.read_text())\n                    framework = data[\"framework\"]\n                    self._frameworks[framework] = [\n                        ComplianceControl(\n                            framework=framework,\n                            **control\n                        )\n                        for control in data.get(\"controls\", [])\n                    ]\n\n    async def _load_services(self):\n        \"\"\"Load service best practices.\"\"\"\n        services_dir = self.DATA_DIR / \"services\"\n        for service_file in services_dir.glob(\"*.yaml\"):\n            data = yaml.safe_load(service_file.read_text())\n            service = data[\"service\"]\n            self._services[service] = [\n                ServiceBestPractice(service=service, **bp)\n                for bp in data.get(\"best_practices\", [])\n            ]\n\n    async def _load_patterns(self):\n        \"\"\"Load security patterns.\"\"\"\n        patterns_dir = self.DATA_DIR / \"patterns\"\n        for pattern_file in patterns_dir.glob(\"*.yaml\"):\n            data = yaml.safe_load(pattern_file.read_text())\n            for pattern in data.get(\"patterns\", []):\n                p = SecurityPattern(**pattern)\n                self._patterns[p.pattern_id] = p\n\n    async def _load_remediation(self):\n        \"\"\"Load remediation templates.\"\"\"\n        remediation_dir = self.DATA_DIR / \"remediation\"\n        # Load from index file\n        index_file = remediation_dir / \"index.yaml\"\n        if index_file.exists():\n            data = yaml.safe_load(index_file.read_text())\n            for template in data.get(\"templates\", []):\n                t = RemediationTemplate(**template)\n                self._remediation[t.rule_id] = t\n\n    # Query methods\n\n    def get_framework_controls(\n        self,\n        framework: str,\n    ) -> list[ComplianceControl]:\n        \"\"\"Get all controls for a framework.\"\"\"\n        return self._frameworks.get(framework.upper(), [])\n\n    def get_control(\n        self,\n        framework: str,\n        control_id: str,\n    ) -> ComplianceControl | None:\n        \"\"\"Get specific control.\"\"\"\n        for control in self._frameworks.get(framework.upper(), []):\n            if control.control_id == control_id:\n                return control\n        return None\n\n    def get_service_best_practices(\n        self,\n        service: str,\n        category: str = None,\n    ) -> list[ServiceBestPractice]:\n        \"\"\"Get best practices for a service.\"\"\"\n        practices = self._services.get(service.upper(), [])\n        if category:\n            practices = [p for p in practices if p.category == category]\n        return practices\n\n    def get_for_framework(\n        self,\n        framework: str,\n    ) -> list[KBEntry]:\n        \"\"\"Get KB entries relevant to a framework.\"\"\"\n        entries = []\n\n        # Add controls\n        for control in self.get_framework_controls(framework):\n            entries.append(\n                KBEntry(\n                    entry_type=\"control\",\n                    framework=framework,\n                    control_name=control.name,\n                    description=control.description,\n                    guidance=control.implementation_guidance,\n                )\n            )\n\n        # Add service practices that reference this framework\n        for service, practices in self._services.items():\n            for practice in practices:\n                if framework in practice.compliance_frameworks:\n                    entries.append(\n                        KBEntry(\n                            entry_type=\"best_practice\",\n                            framework=framework,\n                            service=service,\n                            control_name=practice.title,\n                            description=practice.description,\n                            guidance=practice.implementation,\n                        )\n                    )\n\n        return entries[:20]  # Limit for context\n\n    def get_for_service(\n        self,\n        service: str,\n    ) -> list[KBEntry]:\n        \"\"\"Get KB entries for a service.\"\"\"\n        entries = []\n\n        for practice in self.get_service_best_practices(service):\n            entries.append(\n                KBEntry(\n                    entry_type=\"best_practice\",\n                    service=service,\n                    control_name=practice.title,\n                    description=practice.description,\n                    guidance=practice.implementation,\n                    terraform=practice.terraform_example,\n                    cli=practice.cli_example,\n                )\n            )\n\n        return entries\n\n    def get_remediation(\n        self,\n        rule_id: str,\n    ) -> RemediationTemplate | None:\n        \"\"\"Get remediation template for a rule.\"\"\"\n        return self._remediation.get(rule_id)\n\n    def search(\n        self,\n        query: str,\n        limit: int = 10,\n    ) -> list[KBEntry]:\n        \"\"\"Search KB entries by keyword.\"\"\"\n        query_lower = query.lower()\n        results = []\n\n        # Search controls\n        for framework, controls in self._frameworks.items():\n            for control in controls:\n                if (\n                    query_lower in control.name.lower()\n                    or query_lower in control.description.lower()\n                ):\n                    results.append(\n                        KBEntry(\n                            entry_type=\"control\",\n                            framework=framework,\n                            control_name=control.name,\n                            description=control.description,\n                            guidance=control.implementation_guidance,\n                        )\n                    )\n\n        # Search practices\n        for service, practices in self._services.items():\n            for practice in practices:\n                if (\n                    query_lower in practice.title.lower()\n                    or query_lower in practice.description.lower()\n                ):\n                    results.append(\n                        KBEntry(\n                            entry_type=\"best_practice\",\n                            service=service,\n                            control_name=practice.title,\n                            description=practice.description,\n                            guidance=practice.implementation,\n                        )\n                    )\n\n        return results[:limit]\n\n\n@dataclass\nclass KBEntry:\n    entry_type: str  # control, best_practice, pattern\n    control_name: str\n    description: str\n    guidance: str\n    framework: str = None\n    service: str = None\n    terraform: str = None\n    cli: str = None\n```\n\n### KB Statistics\n\n```\nTotal KB Entities: ~5,500\n- Compliance controls: ~400 (across 6 frameworks)\n- Service best practices: ~300 (20 AWS services \u00d7 15 avg)\n- Security patterns: ~100\n- Remediation templates: ~50\n\nData Size: ~20MB (YAML files baked into container)\n```\n\n## API Endpoints\n\n```\nGET /api/v1/kb/frameworks              # List frameworks\nGET /api/v1/kb/frameworks/:id/controls # Get framework controls\nGET /api/v1/kb/services                # List services\nGET /api/v1/kb/services/:id/practices  # Get service practices\nGET /api/v1/kb/search                  # Search KB\nGET /api/v1/kb/remediation/:rule_id    # Get remediation template\n```\n\n## Files to Create\n\n```\nsrc/ib_platform/kb/\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 service.py               # KB service\n\u251c\u2500\u2500 models.py                # Data models\n\u2514\u2500\u2500 loader.py                # YAML loading\n\ndata/compliance/\n\u251c\u2500\u2500 frameworks/\n\u2502   \u251c\u2500\u2500 hipaa/\n\u2502   \u2502   \u2514\u2500\u2500 controls.yaml\n\u2502   \u251c\u2500\u2500 soc2/\n\u2502   \u2502   \u2514\u2500\u2500 controls.yaml\n\u2502   \u251c\u2500\u2500 pci-dss/\n\u2502   \u2502   \u2514\u2500\u2500 controls.yaml\n\u2502   \u251c\u2500\u2500 gdpr/\n\u2502   \u2502   \u2514\u2500\u2500 controls.yaml\n\u2502   \u251c\u2500\u2500 cis/\n\u2502   \u2502   \u2514\u2500\u2500 controls.yaml\n\u2502   \u2514\u2500\u2500 nist/\n\u2502       \u2514\u2500\u2500 controls.yaml\n\u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 s3.yaml\n\u2502   \u251c\u2500\u2500 ec2.yaml\n\u2502   \u251c\u2500\u2500 rds.yaml\n\u2502   \u251c\u2500\u2500 iam.yaml\n\u2502   \u251c\u2500\u2500 lambda.yaml\n\u2502   \u251c\u2500\u2500 vpc.yaml\n\u2502   \u251c\u2500\u2500 kms.yaml\n\u2502   \u2514\u2500\u2500 ... (20 total)\n\u251c\u2500\u2500 patterns/\n\u2502   \u2514\u2500\u2500 *.yaml\n\u2514\u2500\u2500 remediation/\n    \u2514\u2500\u2500 index.yaml\n\ntests/ib_platform/kb/\n\u251c\u2500\u2500 test_loader.py\n\u251c\u2500\u2500 test_service.py\n\u2514\u2500\u2500 test_queries.py\n```\n\n## Testing Requirements\n\n### Unit Tests\n- [ ] `test_loader.py` - YAML loading\n- [ ] `test_framework_queries.py` - Framework queries\n- [ ] `test_service_queries.py` - Service queries\n- [ ] `test_search.py` - KB search\n\n### Integration Tests\n- [ ] `test_kb_service.py` - Full KB with real data\n- [ ] `test_kb_api.py` - API endpoints\n\n## Acceptance Criteria Checklist\n\n- [ ] 6 compliance frameworks loaded\n- [ ] 20 AWS services with best practices\n- [ ] Security patterns documented\n- [ ] Remediation templates for scanner rules\n- [ ] KB loads at container startup\n- [ ] Query by framework returns controls\n- [ ] Query by service returns practices\n- [ ] Search returns relevant entries\n- [ ] KB size < 25MB\n- [ ] Load time < 5 seconds\n- [ ] 80%+ test coverage\n\n## KB Content Creation\n\nThe KB content should be created by:\n1. Extracting from official compliance documentation\n2. AWS documentation for best practices\n3. CIS Benchmarks for specific checks\n4. Security research for remediation templates\n\nContent should be reviewed for accuracy.\n\n## Dependencies\n\n- None (standalone data)\n\n## Blocked By\n\n- None (first IB component)\n\n## Blocks\n\n- 8.2 Answer Generation (uses KB for context)\n- 7.5 Compliance Mapping (uses KB structure)\n\n## Estimated Effort\n\n2 weeks (1 week code + 1 week content)\n\n## Labels\n\n`kb`, `compliance`, `ib`, `data`, `mvp`, `phase-2`, `P0`\n",
  "labels": [
    "mvp",
    "phase-2",
    "P0",
    "data",
    "compliance",
    "ib",
    "kb"
  ],
  "assignees": [],
  "milestone": null,
  "created_at": null,
  "updated_at": null,
  "state": "OPEN",
  "context": {
    "complexity": "medium",
    "effort": "medium",
    "confidence": 0.8,
    "required_expertise": [
      "backend"
    ],
    "dependencies": [],
    "related_files": []
  },
  "generated_at": "2025-12-04T12:06:42.116952Z",
  "generated_by": "smart-scaffold-cli",
  "branch_name": "feature/issue-39-85knowledgebaseintegration"
}